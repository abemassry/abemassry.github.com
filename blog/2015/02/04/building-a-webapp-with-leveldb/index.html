
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building a webapp with LevelDB - Abe Massry</title>
  <meta name="author" content="Abe Massry">

  
  <meta name="description" content="Building a webapp with LevelDB. I had heard LevelDB was useful as a key value store with good performance, and I thought Express Polls might be a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://abemassry.com/blog/2015/02/04/building-a-webapp-with-leveldb/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Abe Massry" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35802076-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Abe Massry</a></h1>
  
    <h2>Web Development and Building Businesses</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:abemassry.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building a Webapp With LevelDB</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-04T09:35:00-05:00" pubdate data-updated="true">Feb 4<span>th</span>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Building a webapp with LevelDB. I had heard LevelDB was useful as a key value store with good performance, and I thought <a href="http://expresspolls.com">Express Polls</a> might be a good application to use this type of database.  I&#8217;ll go through a few of the steps I used to get it to work. The code is available on <a href="https://github.com">GitHub</a> at <a href="https://github.com/abemassry/express-polls">express-polls</a></p>

<h2>Motivation</h2>

<p>I wanted an online poll that didn&#8217;t require a login. I had used a flash based one before but that was years ago. I also wanted the values to update as people were voting so I knew I wanted to use Socket.IO to handle that. I thought LevelDB might be a good solution to store the data. This was my first attempt at using LevelDB so I thought I would document it here. The only feature of the database I haven&#8217;t looked into is deleting data, so this post will only cover writing and reading.</p>

<h2>Writing to LevelDB</h2>

<p>I started with <a href="https://github.com/rvagg/node-levelup">node-levelup</a>, I heard it was a really good library so I thought I would start there. The readme is very well written with examples and is very clear to understand.  When I actually wrote the webapp the syntax is almost exactly like the examples here.</p>

<p>To start a poll a question and a list of answers are required, this is taken from the user and submitted via POST. Since no login is required a UID is generated and stored with HTML5 LocalStorage on the client.</p>

<p>In order to store different types of values with LevelDB you have to namespace the keys.  This is like different tables in SQL. LevelDB organizes the keys in alphabetical order. So the first namespace I used was the poll. Each poll is going to be unique so in LevelDB there are a few libraries to help namespace the keys properly. I found doing the manual way worked best for me so I spaced them with a &#8216;!&#8217;. There are a few downsides to this such as it&#8217;s a typeable character and you might open yourself up to database injection if you take user data and write to a key with it. I don&#8217;t do that for this webapp but it should be considered an area for improvement.</p>

<p>pact is javascript file that contains most of my requires and then I export them using the nodejs builting export.</p>

<figure class='code'><figcaption><span>Save a key and value to LevelDB</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">question</span><span class="o">:</span> <span class="nx">question</span><span class="p">,</span> <span class="nx">answers</span><span class="o">:</span> <span class="nx">answers</span><span class="p">,</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">uid</span><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">pact</span><span class="p">.</span><span class="nx">getId</span><span class="p">();</span>
</span><span class='line'><span class="nx">pact</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;poll!&#39;</span><span class="o">+</span><span class="nx">key</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/poll/&#39;</span><span class="o">+</span><span class="nx">key</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>I store all the data as strings in JSON format.  I found this was the easiest way for me to interact with javascript objects.</p>

<p>The entire express route is here in the <a href="https://github.com/abemassry/express-polls/blob/master/routes/create.js">create.js</a> file.</p>

<h2>Reading from LevelDB</h2>

<p>Reading from LevelDB is a little more involved for this application so I will be showing the entire poll route here.</p>

<p>Votes are stored with the &#8216;vote!&#8217; namespace, which I will go over writing them in <a href="#reading_and_writing_from_to_leveldb">Reading and Writing from/to LevelDB</a>.</p>

<ol>
<li>Get the poll that you are asking for, once you do that you can get votes associated with that poll.</li>
<li>create a readStream to get a range of values.  This is in <a href="https://github.com/rvagg/node-levelup">node-levelup</a>. Each item is handled with the <code>.on('data'</code> event.  We push each vote to an array that will be then added to a JSON string and sent to the browser.</li>
<li>When the <code>.on('end'</code> event comes through we total everything up because theres no more votes and send everything to the browser.</li>
</ol>


<figure class='code'><figcaption><span>Read from LevelDB and send it to the browser</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">pact</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../pact.js&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">pact</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;poll!&#39;</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; does not exist in poll.js&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; found&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">pollId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">//voteData: voteData,</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">question</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">question</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">stats</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">pact</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">({</span><span class="nx">start</span><span class="o">:</span> <span class="s1">&#39;vote!&#39;</span><span class="o">+</span><span class="nx">pollId</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span>
</span><span class='line'>                                <span class="nx">end</span><span class="o">:</span> <span class="s1">&#39;vote!&#39;</span><span class="o">+</span><span class="nx">pollId</span> <span class="o">+</span> <span class="s1">&#39;!~&#39;</span>
</span><span class='line'>                            <span class="p">})</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">vote</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">vote</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">stats</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vote</span><span class="p">);</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">statsCount</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">stat</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">stat</span> <span class="o">=</span> <span class="nx">statsCount</span><span class="p">[</span><span class="nx">stats</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">statsCount</span><span class="p">[</span><span class="nx">stats</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">stat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">statsCount</span><span class="p">[</span><span class="nx">stats</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">pollAnswers</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">answers</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">voteData</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pollAnswers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">statsCount</span><span class="p">[</span><span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">]])</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">statsCount</span><span class="p">[</span><span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="nx">voteData</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">label</span><span class="o">:</span> <span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
</span><span class='line'>                          <span class="nx">data</span><span class="o">:</span> <span class="nx">statsCount</span><span class="p">[</span><span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
</span><span class='line'>                        <span class="p">};</span>
</span><span class='line'>          <span class="nx">total</span> <span class="o">=</span> <span class="nx">total</span> <span class="o">+</span> <span class="nx">statsCount</span><span class="p">[</span><span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">jsonPayload</span> <span class="o">=</span> <span class="p">{</span><span class="nx">total</span><span class="o">:</span> <span class="nx">total</span><span class="p">,</span> <span class="nx">voteData</span><span class="o">:</span> <span class="nx">voteData</span><span class="p">};</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">jsonPayloadString</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">jsonPayload</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">question</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">question</span> <span class="o">=</span> <span class="s1">&#39;Untitled&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;poll&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">question</span><span class="p">,</span>
</span><span class='line'>                             <span class="nx">pollId</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>                             <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
</span><span class='line'>                             <span class="nx">jsonData</span><span class="o">:</span> <span class="nx">jsonPayloadString</span><span class="p">,</span>
</span><span class='line'>                             <span class="nx">voteData</span><span class="o">:</span> <span class="nx">voteData</span><span class="p">,</span>
</span><span class='line'>                             <span class="nx">render</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>                           <span class="p">}</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">});</span> <span class="c1">// db.get poll end</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The jsonPayload is used to render the plot of votes. It&#8217;s turned into a string so it can be sent over HTTP.</p>

<p>The namespace for each vote key takes the format of &#8216;vote!&#8217; to signify it is a vote <code>pollId</code> which is the poll that vote belongs to and the last part of the <code>createReadStream</code> function is the start which is &#8216;!&#8217; and has a low ascii value to the end &#8216;~&#8217; which has a high ascii value.  The ids I picked to use are all hexadecimal (0-9a-f) so ~ does not show up in the key structure and ! can safely be used as the delimiter for this application.</p>

<p>The documentation goes over createReamStream, but I understand it as it cycles through each value and sends out events.  The .on statement listens for those events, when there is data it is added.  When there is no more data the end event comes through and theres no more data and it is sent to the client.  In SQL this might be equivalent to the <code>SELECT</code> statement.</p>

<h2><a name="reading_and_writing_from_to_leveldb"></a>Reading and Writing from/to LevelDB</h2>

<p>The vote route does a lot so the entire file will be listed here as well.</p>

<ol>
<li>The same as last time we need to get the pollId</li>
<li>We have already checked if this UID had voted before because the view would not display the vote buttons to them and would switch straight to the rendering of the poll graph if they had, so we can store this vote right to the database.</li>
<li>Storing the vote is simple, it&#8217;s the db.put which we went over.</li>
<li>After the new vote is stored the data has to be retrieved on the current voting and pushed out to any clients listening on Socket.IO.  This data is also used in rendering the poll after the vote has taken place.</li>
<li>The data is tallied like it was before, it is pushed out to Socket.IO clients and returned to the user to render the poll.</li>
</ol>


<figure class='code'><figcaption><span>Reading and Writing with LevelDB</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">pact</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../pact.js&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;poll_id&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">pollId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;poll_id&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">uid</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">pact</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;poll!&#39;</span><span class="o">+</span><span class="nx">pollId</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39; does not exist in vote.js&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">voteId</span> <span class="o">=</span> <span class="nx">pact</span><span class="p">.</span><span class="nx">getId</span><span class="p">();</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">answer</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;answer&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">putValue</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">vote</span><span class="o">:</span> <span class="nx">answer</span><span class="p">};</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">stats</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">pact</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;vote!&#39;</span> <span class="o">+</span> <span class="nx">pollId</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span> <span class="o">+</span> <span class="nx">voteId</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">putValue</span><span class="p">),</span>
</span><span class='line'>        <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;db error&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
</span><span class='line'>          <span class="c1">// get current poll stats</span>
</span><span class='line'>          <span class="nx">pact</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">({</span><span class="nx">start</span><span class="o">:</span> <span class="s1">&#39;vote!&#39;</span><span class="o">+</span><span class="nx">pollId</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span>
</span><span class='line'>                                      <span class="nx">end</span><span class="o">:</span> <span class="s1">&#39;vote!&#39;</span><span class="o">+</span><span class="nx">pollId</span> <span class="o">+</span> <span class="s1">&#39;!~&#39;</span>
</span><span class='line'>                                  <span class="p">})</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">vote</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">vote</span><span class="p">;</span>
</span><span class='line'>              <span class="nx">stats</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vote</span><span class="p">);</span>
</span><span class='line'>            <span class="p">})</span>
</span><span class='line'>            <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">statsCount</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">stat</span><span class="p">;</span>
</span><span class='line'>              <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">stat</span> <span class="o">=</span> <span class="nx">statsCount</span><span class="p">[</span><span class="nx">stats</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="nx">statsCount</span><span class="p">[</span><span class="nx">stats</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">stat</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="nx">statsCount</span><span class="p">[</span><span class="nx">stats</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">pollAnswers</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">answers</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">voteData</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>              <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">pollAnswers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">statsCount</span><span class="p">[</span><span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">]])</span> <span class="p">{</span>
</span><span class='line'>                  <span class="nx">statsCount</span><span class="p">[</span><span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="nx">voteData</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">label</span><span class="o">:</span> <span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
</span><span class='line'>                                <span class="nx">data</span><span class="o">:</span> <span class="nx">statsCount</span><span class="p">[</span><span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
</span><span class='line'>                              <span class="p">};</span>
</span><span class='line'>                <span class="nx">total</span> <span class="o">=</span> <span class="nx">total</span> <span class="o">+</span> <span class="nx">statsCount</span><span class="p">[</span><span class="nx">pollAnswers</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">total</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">jsonPayload</span> <span class="o">=</span> <span class="p">{</span><span class="nx">total</span><span class="o">:</span> <span class="nx">total</span><span class="p">,</span> <span class="nx">voteData</span><span class="o">:</span> <span class="nx">voteData</span><span class="p">};</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">jsonPayloadString</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">jsonPayload</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">pact</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">pollId</span><span class="p">,</span> <span class="nx">jsonPayloadString</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">jsonPayloadString</span><span class="p">);</span>
</span><span class='line'>              <span class="c1">//var voteData = [</span>
</span><span class='line'>              <span class="c1">//  { label: &quot;Polls&quot;,  data: 20},</span>
</span><span class='line'>              <span class="c1">//  { label: &quot;Learning&quot;,  data: 50},</span>
</span><span class='line'>              <span class="c1">//  { label: &quot;Fun&quot;,  data: 30}</span>
</span><span class='line'>              <span class="c1">//];</span>
</span><span class='line'>              <span class="c1">//res.end</span>
</span><span class='line'>              <span class="c1">// update with websockets</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>            <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>This route is called with AJAX.</p>

<h2>Future work</h2>

<p>There are a lot of other moving parts to the webapp so the examples aren&#8217;t as simple as they could be, but I wanted to show what LevelDB looks like inside of a functioning webapp with other things going on as well.</p>

<p>Using a different namespace separator, something like &#8216;x/00&#8217;. Couldn&#8217;t get that to work at the time but I would like to look into it more.</p>

<p>This is not related to LevelDB but I have seen some inconsistencies with the HTML5 LocalStorage UID scheme and I would like to look into that further.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Abe Massry</span></span>

      








  


<time datetime="2015-02-04T09:35:00-05:00" pubdate data-updated="true">Feb 4<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/nosql/'>NoSQL</a>, <a class='category' href='/blog/categories/databases/'>databases</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/leveldb/'>leveldb</a>, <a class='category' href='/blog/categories/levelup/'>levelup</a>, <a class='category' href='/blog/categories/nodejs/'>nodejs</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://abemassry.com/blog/2015/02/04/building-a-webapp-with-leveldb/" data-via="abemassry" data-counturl="http://abemassry.com/blog/2015/02/04/building-a-webapp-with-leveldb/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/04/15/near-field-messenger/" title="Previous Post: Near Field Messenger - Connect with People Around You">&laquo; Near Field Messenger - Connect with People Around You</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/04/building-a-webapp-with-leveldb/">Building a webapp with LevelDB</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/15/near-field-messenger/">Near Field Messenger - Connect with People Around You</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/14/building-wsend/">Building wsend - A Command Line Tool to Easily Send Files</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/15/5-things-i-use-for-productivity/">5 Things I use for Productivity</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/01/ntfs-on-osx-10-dot-7/">NTFS on OSX 10.7</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/abemassry">@abemassry</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'abemassry',
            count: 3,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
</section>
<section>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/abemassry" class="twitter-follow-button" data-show-count="false">Follow @abemassry</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Abe Massry -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'abemassry';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://abemassry.com/blog/2015/02/04/building-a-webapp-with-leveldb/';
        var disqus_url = 'http://abemassry.com/blog/2015/02/04/building-a-webapp-with-leveldb/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
